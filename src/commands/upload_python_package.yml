description:
  Upload a python package to a Cloudsmith repository using the Cloudsmith CLI
parameters:
  repository:
    description: The identity/slug of the Cloudsmith repository
    type: string
  service_account:
    description: The identity/slug of the Cloudsmith service account to use when authenticating
    type: string
  source_dist:
    description: The path of the source distribution file to upload
    type: string
    default: None
  wheel:
    description: The location of the wheel (.whl) file to upload
    type: string
    default: None
steps:
  - run:
      name: Cloudsmith - Install CLI
      command: |
        python -m ensurepip --upgrade

        echo ""
        echo "Installing cloudsmith-cli using pip ..."

        python -m pip install cloudsmith-cli --upgrade --user --extra-index-url=https://dl.cloudsmith.io/public/cloudsmith/cli/python/index/

        echo ""
        echo "Cloudsmith CLI installed OK."

        cloudsmith --version
  - authenticate_with_oidc:
      service_account: <<parameters.service_account>>
  - when:
      condition:
        not:
          equal: [ "", "<<parameters.source_dist>>"]
      steps:
        - run:
            name: Cloudsmith - Upload source distribution
            command: |
              echo ""
              echo "Uploading package <<parameters.package_path>> to Cloudsmith repository $CLOUDSMITH_ORGANISATION/<<parameters.repository>> ..."

              cloudsmith push python --verbose --api-key "$CLOUDSMITH_OIDC_TOKEN" "$CLOUDSMITH_ORGANISATION/<<parameters.repository>>" "<<parameters.source_dist>>"

              echo ""
              echo "Package upload and synchronisation completed OK."
  - when:
      condition:
        not:
          equal: [ "", "<<parameters.wheel>>"]
      steps:
        - run:
            name: Cloudsmith - Upload wheel distribution
            command: |
              echo ""
              echo "Uploading package <<parameters.package_path>> to Cloudsmith repository $CLOUDSMITH_ORGANISATION/<<parameters.repository>> ..."

              cloudsmith push python --verbose --api-key "$CLOUDSMITH_OIDC_TOKEN" "$CLOUDSMITH_ORGANISATION/<<parameters.repository>>" "<<parameters.wheel>>"

              echo ""
              echo "Package upload and synchronisation completed OK."

description:
  Generate temporary Cloudsmith credentials using OIDC and upload a python package to a Cloudsmith repository using the
  Cloudsmith CLI.
parameters:
  repository:
    description: The identity/slug of the Cloudsmith repository
    type: string
  service_account:
    description: The identity/slug of the Cloudsmith service account to use when authenticating
    type: string
  dist_dir:
    description: The distribution directory where package source distribution and wheel files are located
    type: string
    default: "dist"
steps:
  - run:
      name: Cloudsmith - Install CLI
      command: |
        python -m ensurepip --upgrade

        echo "Installing cloudsmith-cli using pip ..."

        python -m pip install cloudsmith-cli --upgrade --user --extra-index-url=https://dl.cloudsmith.io/public/cloudsmith/cli/python/index/

        echo ""
        echo "Cloudsmith CLI installed OK."

        cloudsmith --version
  - authenticate_with_oidc:
      service_account: <<parameters.service_account>>
  - run:
      name: Cloudsmith - Check dist_dir is valid
      command: |
        if [ -d "<<parameters.dist_dir>>" ]; then
          echo "<<parameters.dist_dir>> is a directory"
        else
          echo "<<parameters.dist_dir>> is not a directory"
          exit 1
        fi
  - run:
      name: Cloudsmith - Upload source distribution(s)
      command:
        for f in "<<parameters.dist_dir>>/*.tar.gz"
        do
          echo "Uploading source distribution $f to Cloudsmith repository $CLOUDSMITH_ORGANISATION/<<parameters.repository>> ..."

          cloudsmith push python --verbose --api-key "$CLOUDSMITH_OIDC_TOKEN" "$CLOUDSMITH_ORGANISATION/<<parameters.repository>>" "$f"

          echo ""
          echo "Package upload and synchronisation completed OK."
        done
  - run:
      name: Cloudsmith - Upload wheel distribution(s)
      command: |
        for f in "<<parameters.dist_dir>>/*.whl"
        do
          echo "Uploading wheel $f to Cloudsmith repository $CLOUDSMITH_ORGANISATION/<<parameters.repository>> ..."

          cloudsmith push python --verbose --api-key "$CLOUDSMITH_OIDC_TOKEN" "$CLOUDSMITH_ORGANISATION/<<parameters.repository>>" "$f"

          echo ""
          echo "Package upload and synchronisation completed OK."
        done

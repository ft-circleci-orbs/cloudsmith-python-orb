description:
  Upload a python package
parameters:
  repository:
    description: The identity/slug of the Cloudsmith repository
    type: string
  service_account:
    description: The identity/slug of the Cloudsmith service account to use when authenticating
    type: string
  package_path:
    description: The location of the package files to upload
    type: string
steps:
  - authenticate_with_oidc:
      service_account: <<parameters.service_account>>
  - run:
      name: Install Cloudsmith CLI
      command: |
        python -m ensurepip --upgrade
        pip install cloudsmith-cli==1.1.1 --upgrade --user --extra-index-url=https://dl.cloudsmith.io/public/cloudsmith/cli/python/index/
        cloudsmith --version
  - run:
      name: Upload package to Cloudsmith
      command: |
        echo $CLOUDSMITH_OIDC_TOKEN
        echo $CLOUDSMITH_ORGANISATION
        CLOUDSMITH_API_KEY="$CLOUDSMITH_OIDC_TOKEN"
        cloudsmith push python "$CLOUDSMITH_ORGANISATION/<<parameters.repository>>" "<<parameters.package_path>>"
